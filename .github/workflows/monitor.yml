name: Uptime monitor

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch: {}

jobs:
  check:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      VPS_BASE_URL: ${{ secrets.VPS_BASE_URL }}
    steps:
      - name: Check GitHub Pages (if applicable)
        shell: bash
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%%/*}"
          repo="${GITHUB_REPOSITORY##*/}"
          base="https://${owner}.github.io/${repo}"
          for path in "/" "/sitemap.xml" "/robots.txt"; do
            code=$(curl -s -o /dev/null -w '%{http_code}' -L "$base$path" || true)
            echo "$base$path -> $code"
          done

      - name: Check VPS (if secrets provided)
        if: ${{ env.VPS_BASE_URL != '' }}
        shell: bash
        run: |
          set -euo pipefail
          base="${VPS_BASE_URL%/}"
          for path in "/" "/content/index.html" "/api/tree"; do
            code=$(curl -s -o /dev/null -w '%{http_code}' -L "$base$path" || true)
            echo "$base$path -> $code"
            if [ "$code" != "200" ]; then
              echo "Endpoint failed: $base$path ($code)"; exit 1
            fi
          done

